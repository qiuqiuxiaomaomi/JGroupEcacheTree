# JGroupsEhCacheTree
EhCache 分布式本地缓存


![](https://i.imgur.com/rNJiYWH.png)

<pre>
Ehcache是一个纯Java的进程内缓存框架。
由于Ehcache是进程内的缓存系统，一旦将应用部署在集群环境中，每个节点维护各自的缓存数据，当某
个节点对缓存数据进行更新，这些 更新的数据无法在其他节点中共享，这不仅会降低节点运行的效率，
而且会导致数据不同步的情况发生，所以就需要用到EhCache的集群解决方案：
    Ehcache支持5中集群方案：
        1）RMI
        2）JMS
        3) JGroups
        5) EhCache Server

    JGroups 提供了基于TCP的淡薄和基于UDP的多播，对应RMI的手工配置和自动发现。
</pre>

<pre>
JGroups

         JGroups是一个开源的纯Java编写的可靠的群组通信工具。其工作模式基于IP多播，但可以
     在可靠性和群组成员管理上进行扩展，其结构上设计灵活性，提供了一种灵活兼容多种协议的
     协议栈。

         JGroups多线程的方式实现了多个协议之间的协同工作，常见的工作线程有心跳检测，诊断等。

         JGroups实现多机器之间的通信一般都会包括维护群组的状态，群组通信协议，群组数据可
     靠性传输这样的一些主题。

         目前JBOSS，Ehcache的分布式缓存是基于JGroups通信的。
</pre>

<pre>
Ehcache使用场景

      1：比较少的更新数据表的情况
      2：对并发要求不是很严格的情况
         多台应用服务器中的缓存不能进行实时同步
      3：对一致性要求不高的情况
         因为Ehcache本地缓存的特性，目前无法很好的解决不同服务器间缓存同步的问题，所以我
         们在一致性要求非常高的场合下，尽量使用Redis、Memcached等集中式缓存。
</pre>

###组播方式
原理：当缓存改变时,ehcache会向组播IP地址和端口号发送RMI UDP组播包。
缺陷：Ehcache的组播做得比较初级,功能只是基本实现(比如简单的一个HUB,接两台单网卡的服务器,
互相之间组播同步就没问题)，对一些复杂的环境(比如多台服务器,每台服务器上多地址，尤其是集群，
存在一个集群地址带多个物理机，每台物理机又带多个虚拟站的子地址)，就容易出现问题。

![](https://i.imgur.com/IS5o6Sk.png)

###JMS消息监听方式
原理：这种模式的核心就是一个消息队列，每个应用节点都订阅预先定义好的主题，同时，节点有元素
更新时，也会发布更新元素到主题中去。各个应用服务器节点通过侦听MQ获取到最新的数据，然后分别
更新自己的Ehcache缓存，Ehcache默认支持ActiveMQ，我们也可以通过自定义组件的方式实现类似
Kafka，RabbitMQ。
![](https://i.imgur.com/VPfjxje.png)

<pre>
使用Ehcache的瓶颈:

     1、缓存漂移（Cache Drift）：每个应用节点只管理自己的缓存，在更新某个节点的时候，不会
       影响到其他的节点，这样数据之间可能就不同步了。

     2、数据库瓶颈（Database Bottlenecks ）：对于单实例的应用来说，缓存可以保护数据库的读
       风暴；但是，在集群的环境下，每一个应用节点都要定期保持数据最新，节点越多，要维持这样
       的情况对数据库的开销也越大。
</pre>

实际工作中如何使用Ehcache：
![](https://i.imgur.com/21Txqfa.png)

注意：
    这种方式通过应用服务器的Ehcache定时轮询Redis缓存服务器更同步更新本地缓存，缺点是因为
    每台服务器定时Ehcache的时间不一样，那么不同服务器刷新最新缓存的时间也不一样，会产生数
    据不一致问题，对一致性要求不高可以使用。

![](https://i.imgur.com/w0MFLkh.png)
注意：
    通过引入了MQ队列，使每台应用服务器的Ehcache同步侦听MQ消息，这样在一定程度上可以达到准
    同步更新数据，通过MQ推送或者拉取的方式，但是因为不同服务器之间的网络速度的原因，所以也
    不能完全达到强一致性。基于此原理使用Zookeeper等分布式协调通知组件也是如此。

总结：
    1、使用二级缓存的好处是减少缓存数据的网络传输开销，当集中式缓存出现故障的时候，Ehcache
      等本地缓存依然能够支撑应用程序正常使用，增加了程序的健壮性。另外使用二级缓存策略可以在
      一定程度上阻止缓存穿透问题。

    2、根据CAP原理我们可以知道，如果要使用强一致性缓存（根据自身业务决定），集中式缓存是最佳
      选择，如（Redis，Memcached等）。

